<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PackMaster v3.0 - Liste de Voyage Intelligente</title>
    <meta name="theme-color" content="#4CAF50">
    <meta name="description" content="Votre assistant packing intelligent avec m√©t√©o et IA">
    
    <style>
        :root {
            --primary-color: #4CAF50;
            --primary-dark: #388E3C;
            --secondary-color: #2196F3;
            --secondary-dark: #1976D2;
            --danger-color: #f44336;
            --warning-color: #FF9800;
            --info-color: #00BCD4;
            --light-color: #f5f7fa;
            --dark-color: #333;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }
        
        body { 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            background: var(--light-color); 
            padding: 20px; 
            max-width: 1200px; 
            margin: 0 auto;
            color: var(--dark-color);
        }
        
        .app-container {
            background: white;
            border-radius: 15px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        
        .header { 
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .voyage-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }
        
        input, select, button {
            padding: 12px 15px;
            border: 2px solid transparent;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        button { 
            background: var(--primary-color); 
            color: white; 
            border: none; 
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }
        
        button:hover { 
            background: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        button.secondary {
            background: var(--secondary-color);
        }
        
        button.secondary:hover {
            background: var(--secondary-dark);
        }
        
        .main-content {
            padding: 25px;
            display: grid;
            gap: 20px;
        }
        
        .section-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }
        
        .weather-card {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
        }
        
        .ai-suggestions {
            background: #f8f9fa;
            border-left: 4px solid var(--info-color);
            padding: 15px;
            border-radius: 8px;
        }
        
        .sync-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1000;
        }
        
        .sync-online { background: var(--primary-color); color: white; }
        .sync-offline { background: var(--warning-color); color: white; }
        
        .export-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .categorie-card {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        
        .categorie-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
        }
        
        .items-container {
            padding: 15px;
        }
        
        .item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
            transition: background 0.3s;
        }
        
        .item:hover {
            background: #f5f5f5;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 25px;
            background: var(--dark-color);
            color: white;
            border-radius: 8px;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1001;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast.success {
            background: var(--primary-color);
        }
        
        @media (max-width: 768px) {
            .categories-grid {
                grid-template-columns: 1fr;
            }
            .voyage-info {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>üß≥ PackMaster v3.0</h1>
            <p>Votre assistant packing intelligent avec m√©t√©o et IA</p>
            
            <div class="voyage-info">
                <input type="text" id="nomVoyage" placeholder="Nom du voyage" value="Week-end √† Paris">
                <input type="text" id="destination" placeholder="Destination">
                <input type="number" id="duree" placeholder="Dur√©e en jours" value="3" min="1">
                <select id="typeVoyage">
                    <option value="ville">üèôÔ∏è Ville</option>
                    <option value="plage">üèñÔ∏è Plage</option>
                    <option value="rando">ü•æ Randonn√©e</option>
                    <option value="affaires">üíº Affaires</option>
                    <option value="camping">‚õ∫ Camping</option>
                    <option value="ski">‚õ∑Ô∏è Ski</option>
                </select>
                <button onclick="sauvegarderDonnees()">üíæ Sauvegarder</button>
            </div>
        </div>

        <div class="main-content">
            <!-- Section M√©t√©o -->
            <div class="weather-card" id="weatherSection">
                <h3>üå§Ô∏è M√©t√©o √† destination</h3>
                <div id="weatherInfo">Chargement de la m√©t√©o...</div>
            </div>

            <!-- Suggestions IA -->
            <div class="ai-suggestions" id="aiSuggestions">
                <h4>ü§ñ Suggestions intelligentes</h4>
                <div id="suggestionsList">Chargement des suggestions...</div>
            </div>

            <!-- Options d'export -->
            <div class="section-card">
                <h3>üìä Export Avanc√©</h3>
                <div class="export-options">
                    <button onclick="exporterPDF()" class="secondary">üìÑ Exporter PDF</button>
                    <button onclick="exporterExcel()" class="secondary">üìä Exporter Excel</button>
                    <button onclick="partagerListeAvance()" class="secondary">üë• Partager avanc√©</button>
                </div>
            </div>

            <!-- Gestion des cat√©gories -->
            <div class="section-card">
                <h3>üìÅ Gestion des cat√©gories</h3>
                <div style="display: flex; gap: 12px; margin-top: 15px;">
                    <input type="text" id="nomNouvelleCategorie" placeholder="Nom de la nouvelle cat√©gorie" style="flex: 1;">
                    <button onclick="ajouterCategorie()">‚ûï Cr√©er une cat√©gorie</button>
                </div>
            </div>

            <!-- Liste des cat√©gories -->
            <div class="categories-grid" id="categoriesContainer">
                <!-- Les cat√©gories seront g√©n√©r√©es ici -->
            </div>

            <!-- Statistiques -->
            <div class="stats-card">
                <div>
                    <h3 style="color: white; margin-bottom: 10px;">üìä Progression du packing</h3>
                    <div id="progression">0/0 articles pr√©par√©s (0%)</div>
                </div>
                <div class="progression-bar" style="height: 10px; background: rgba(255,255,255,0.3); border-radius: 5px; margin: 15px 0; overflow: hidden;">
                    <div class="progression-remplissage" id="progressionBar" style="height: 100%; background: white; border-radius: 5px; transition: width 0.5s; width: 0%"></div>
                </div>
                <div style="display: flex; gap: 12px; justify-content: center; margin-top: 15px;">
                    <button onclick="exporterPDF()" class="secondary">üìÑ PDF</button>
                    <button onclick="exporterExcel()" class="secondary">üìä Excel</button>
                    <button onclick="partagerListeAvance()" class="secondary">üë• Partager</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast notifications -->
    <div class="toast" id="toast"></div>

    <script>
        // =============================================================================
        // CONFIGURATION
        // =============================================================================
        
        const CONFIG = {
            STORAGE_KEYS: {
                MAIN: 'packmaster_v3_data',
                BACKUP: 'packmaster_v3_backup',
                AI_LEARNING: 'packmaster_ai_learning'
            }
        };

        // =============================================================================
        // GESTION DU STOCKAGE AVANC√â
        // =============================================================================
        
        class StorageManager {
            constructor() {
                this.isIndexedDBSupported = 'indexedDB' in window;
                this.initStorage();
            }
            
            async initStorage() {
                if (this.isIndexedDBSupported) {
                    await this.setupIndexedDB();
                }
            }
            
            setupIndexedDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open('PackMasterDB', 1);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        this.db = request.result;
                        resolve(this.db);
                    };
                    
                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        if (!db.objectStoreNames.contains('lists')) {
                            db.createObjectStore('lists', { keyPath: 'id' });
                        }
                    };
                });
            }
            
            async saveData(key, data) {
                try {
                    // Essayer IndexedDB en premier
                    if (this.isIndexedDBSupported && this.db) {
                        await this.saveToIndexedDB(key, data);
                    }
                    
                    // Fallback sur LocalStorage
                    localStorage.setItem(key, JSON.stringify(data));
                    
                    return true;
                } catch (error) {
                    console.error('Erreur sauvegarde:', error);
                    // Fallback final
                    try {
                        localStorage.setItem(key, JSON.stringify(data));
                        return true;
                    } catch (e) {
                        console.error('Erreur sauvegarde finale:', e);
                        return false;
                    }
                }
            }
            
            async saveToIndexedDB(key, data) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['lists'], 'readwrite');
                    const store = transaction.objectStore('lists');
                    const request = store.put({ 
                        id: key, 
                        data: data, 
                        timestamp: Date.now() 
                    });
                    
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }
            
            async loadData(key) {
                try {
                    // Essayer IndexedDB en premier
                    if (this.isIndexedDBSupported && this.db) {
                        const indexedData = await this.loadFromIndexedDB(key);
                        if (indexedData) return indexedData;
                    }
                    
                    // Fallback sur LocalStorage
                    const localData = localStorage.getItem(key);
                    return localData ? JSON.parse(localData) : null;
                } catch (error) {
                    console.error('Erreur chargement:', error);
                    const localData = localStorage.getItem(key);
                    return localData ? JSON.parse(localData) : null;
                }
            }
            
            async loadFromIndexedDB(key) {
                return new Promise((resolve, reject) => {
                    const transaction = this.db.transaction(['lists'], 'readonly');
                    const store = transaction.objectStore('lists');
                    const request = store.get(key);
                    
                    request.onsuccess = () => resolve(request.result ? request.result.data : null);
                    request.onerror = () => reject(request.error);
                });
            }
            
            async getStorageStats() {
                return {
                    indexedDBSupported: this.isIndexedDBSupported,
                    totalAvailable: this.isIndexedDBSupported ? '‚â• 50MB' : '5MB (LocalStorage)'
                };
            }
        }

        // =============================================================================
        // SERVICE M√âT√âO
        // =============================================================================
        
        class WeatherService {
            constructor() {
                this.cache = new Map();
            }
            
            async getWeather(destination) {
                if (!destination) {
                    return this.getFallbackWeather();
                }
                
                try {
                    // Simulation de donn√©es m√©t√©o r√©alistes
                    await new Promise(resolve => setTimeout(resolve, 800));
                    
                    const weatherPatterns = {
                        'paris': { temp: 12, condition: 'nuageux', rain: 40 },
                        'londres': { temp: 10, condition: 'pluvieux', rain: 70 },
                        'barcelone': { temp: 22, condition: 'ensoleill√©', rain: 10 },
                        'new york': { temp: 15, condition: 'partiellement nuageux', rain: 25 },
                        'default': { temp: 18, condition: 'ensoleill√©', rain: 15 }
                    };
                    
                    const pattern = weatherPatterns[destination.toLowerCase()] || weatherPatterns.default;
                    
                    return {
                        temperature: pattern.temp,
                        condition: pattern.condition,
                        rainProbability: pattern.rain,
                        humidity: 60 + Math.random() * 25,
                        wind: 8 + Math.random() * 12,
                        icon: this.getWeatherIcon(pattern.condition)
                    };
                } catch (error) {
                    console.error('Erreur m√©t√©o:', error);
                    return this.getFallbackWeather();
                }
            }
            
            getWeatherIcon(condition) {
                const icons = {
                    'ensoleill√©': '‚òÄÔ∏è',
                    'nuageux': '‚òÅÔ∏è',
                    'pluvieux': 'üåßÔ∏è',
                    'partiellement nuageux': '‚õÖ'
                };
                return icons[condition] || 'üåà';
            }
            
            getFallbackWeather() {
                return {
                    temperature: 18,
                    condition: 'ensoleill√©',
                    rainProbability: 20,
                    humidity: 65,
                    wind: 10,
                    icon: '‚òÄÔ∏è'
                };
            }
            
            generateWeatherSuggestions(weatherData, voyageType) {
                const suggestions = [];
                
                if (weatherData.rainProbability > 50) {
                    suggestions.push('‚òî Parapluie ou imperm√©able');
                    suggestions.push('üëü Chaussures imperm√©ables');
                }
                
                if (weatherData.temperature < 10) {
                    suggestions.push('üß• V√™tements chauds');
                    suggestions.push('üß§ Gants et bonnet');
                }
                
                if (weatherData.temperature > 25) {
                    suggestions.push('üß¥ Cr√®me solaire SPF50');
                    suggestions.push('üëí Chapeau ou casquette');
                }
                
                if (weatherData.wind > 15) {
                    suggestions.push('üß• Coupe-vent');
                }
                
                return suggestions;
            }
        }

        // =============================================================================
        // SYST√àME DE SUGGESTIONS IA
        // =============================================================================
        
        class AISuggestionEngine {
            constructor() {
                this.userPreferences = this.loadPreferences();
            }
            
            loadPreferences() {
                return JSON.parse(localStorage.getItem(CONFIG.STORAGE_KEYS.AI_LEARNING) || '{"patterns": {}}');
            }
            
            async generateSuggestions(voyageData, weatherData) {
                const suggestions = new Set();
                
                // Suggestions bas√©es sur le type de voyage
                suggestions.add(...this.getTypeBasedSuggestions(voyageData.type));
                
                // Suggestions bas√©es sur la m√©t√©o
                if (weatherData) {
                    const weatherService = new WeatherService();
                    suggestions.add(...weatherService.generateWeatherSuggestions(weatherData, voyageData.type));
                }
                
                // Suggestions bas√©es sur la dur√©e
                suggestions.add(...this.getDurationBasedSuggestions(voyageData.duree));
                
                return Array.from(suggestions).slice(0, 8);
            }
            
            getTypeBasedSuggestions(voyageType) {
                const typeSuggestions = {
                    'ville': ['Chargeur portable', 'Carte de transport', 'Guide touristique', 'Appareil photo'],
                    'plage': ['Cr√®me solaire', 'Serviette de plage', 'Lunettes de soleil', 'Sandales'],
                    'rando': ['Gourde', 'Carte topographique', 'Trousse de secours', 'Lampe frontale'],
                    'affaires': ['Costume', 'Carte de visite', 'Ordinateur portable', 'Documents importants'],
                    'camping': ['Tente', 'Sac de couchage', 'R√©chaud', 'Lampe torche'],
                    'ski': ['Combinaison', 'Casque', 'Gants', 'Cr√®me solaire visage']
                };
                
                return typeSuggestions[voyageType] || [];
            }
            
            getDurationBasedSuggestions(duration) {
                if (duration <= 2) {
                    return ['Kit toilette voyage', 'Sous-v√™tements de rechange'];
                } else if (duration <= 5) {
                    return ['Produits de lessive', 'Plusieurs changes complets'];
                } else {
                    return ['Lessive en voyage', 'Pharmacie compl√®te', 'Adaptateur universel'];
                }
            }
        }

        // =============================================================================
        // SYST√àME DE SYNCHRONISATION
        // =============================================================================
        
        class SyncManager {
            constructor(storageManager) {
                this.storageManager = storageManager;
                this.isOnline = navigator.onLine;
                this.setupEventListeners();
                this.updateSyncStatus();
            }
            
            setupEventListeners() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    this.updateSyncStatus();
                    this.showToast('üü¢ Connexion r√©tablie', 'success');
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    this.updateSyncStatus();
                    this.showToast('üü° Mode hors ligne activ√©', 'success');
                });
            }
            
            updateSyncStatus() {
                let statusElement = document.getElementById('syncStatus');
                if (!statusElement) {
                    statusElement = document.createElement('div');
                    statusElement.id = 'syncStatus';
                    statusElement.className = 'sync-status';
                    document.body.appendChild(statusElement);
                }
                
                statusElement.className = `sync-status ${this.isOnline ? 'sync-online' : 'sync-offline'}`;
                statusElement.textContent = this.isOnline ? 'üü¢ En ligne' : 'üü° Hors ligne';
            }
            
            showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast ${type} show`;
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
        }

        // =============================================================================
        // SYST√àME D'EXPORT AVANC√â
        // =============================================================================
        
        class ExportManager {
            async exporterPDF() {
                try {
                    // Cr√©ation d'un PDF simple
                    const voyageData = await storageManager.loadData(CONFIG.STORAGE_KEYS.MAIN);
                    let contenuPDF = `üß≥ PACKMASTER - LISTE DE VOYAGE\n\n`;
                    
                    if (voyageData && voyageData.voyage) {
                        contenuPDF += `Voyage: ${voyageData.voyage.nom}\n`;
                        contenuPDF += `Destination: ${voyageData.voyage.destination}\n`;
                        contenuPDF += `Dur√©e: ${voyageData.voyage.duree} jours\n\n`;
                    }
                    
                    if (voyageData && voyageData.categories) {
                        for (const [categorie, articles] of Object.entries(voyageData.categories)) {
                            contenuPDF += `üìÇ ${categorie}:\n`;
                            for (const article of articles) {
                                const nom = article.nom || article;
                                const statut = article.coche ? '‚úÖ' : '‚òê';
                                contenuPDF += `  ${statut} ${nom} (x${article.quantite || 1})\n`;
                            }
                            contenuPDF += '\n';
                        }
                    }
                    
                    // Cr√©ation du blob PDF
                    const blob = new Blob([contenuPDF], { type: 'application/pdf' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `packmaster-${voyageData?.voyage?.nom || 'liste'}.pdf`;
                    a.click();
                    
                    this.showToast('üìÑ PDF export√© avec succ√®s!', 'success');
                    
                } catch (error) {
                    console.error('Erreur export PDF:', error);
                    this.showToast('‚ùå Erreur lors de l\'export PDF', 'error');
                }
            }
            
            async exporterExcel() {
                try {
                    const voyageData = await storageManager.loadData(CONFIG.STORAGE_KEYS.MAIN);
                    let contenuCSV = 'Cat√©gorie,Article,Quantit√©,Statut,Bagage\n';
                    
                    if (voyageData && voyageData.categories) {
                        for (const [categorie, articles] of Object.entries(voyageData.categories)) {
                            for (const article of articles) {
                                const nom = article.nom || article;
                                const statut = article.coche ? 'Pr√™t' : '√Ä pr√©parer';
                                const bagage = article.bagage === 'soute' ? 'Soute' : 'Main';
                                contenuCSV += `"${categorie}","${nom}",${article.quantite || 1},"${statut}","${bagage}"\n`;
                            }
                        }
                    }
                    
                    const blob = new Blob([contenuCSV], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `packmaster-${voyageData?.voyage?.nom || 'liste'}.csv`;
                    a.click();
                    
                    this.showToast('üìä Excel export√© avec succ√®s!', 'success');
                    
                } catch (error) {
                    console.error('Erreur export Excel:', error);
                    this.showToast('‚ùå Erreur lors de l\'export Excel', 'error');
                }
            }
            
            showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = `toast ${type} show`;
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
        }

        // =============================================================================
        // INITIALISATION GLOBALE
        // =============================================================================
        
        // Instances globales
        const storageManager = new StorageManager();
        const weatherService = new WeatherService();
        const aiEngine = new AISuggestionEngine();
        const syncManager = new SyncManager(storageManager);
        const exportManager = new ExportManager();

        // Donn√©es par d√©faut
        const modeles = {
            ville: {
                "V√™tements": ["T-shirts", "Pantalons", "Sous-v√™tements", "Chaussettes", "Pyjama"],
                "Toilette": ["Brosse √† dents", "Dentifrice", "Shampoing", "D√©odorant"],
                "√âlectronique": ["Chargeur t√©l√©phone", "Powerbank", "√âcouteurs"],
                "Documents": ["Carte d'identit√©", "Cartes de cr√©dit", "Billets"]
            },
            plage: {
                "V√™tements": ["Maillots de bain", "Short", "T-shirts", "Chapeau"],
                "Protection": ["Cr√®me solaire", "Lunettes de soleil"],
                "Plage": ["Serviette", "Parasol", "Glaci√®re"]
            },
            rando: {
                "√âquipement": ["Chaussures rando", "Sac √† dos", "Gourde"],
                "V√™tements": ["Veste imperm√©able", "Polaires", "Bonnet"],
                "S√©curit√©": ["Trousse secours", "Lampe frontale", "Carte"]
            }
        };

        let listeActuelle = {};

        // =============================================================================
        // FONCTIONS PRINCIPALES
        // =============================================================================
        
        async function initialiserApplication() {
            await storageManager.initStorage();
            await chargerDonnees();
            genererCategories();
            mettreAJourProgression();
            await chargerMeteo();
            await genererSuggestionsIA();
            
            showToast('üöÄ PackMaster v3.0 initialis√©!', 'success');
        }
        
        async function chargerDonnees() {
            const donnees = await storageManager.loadData(CONFIG.STORAGE_KEYS.MAIN);
            if (donnees) {
                listeActuelle = donnees.categories || {};
                if (donnees.voyage) {
                    document.getElementById('nomVoyage').value = donnees.voyage.nom || '';
                    document.getElementById('destination').value = donnees.voyage.destination || '';
                    document.getElementById('duree').value = donnees.voyage.duree || 3;
                    document.getElementById('typeVoyage').value = donnees.voyage.type || 'ville';
                }
            } else {
                listeActuelle = JSON.parse(JSON.stringify(modeles.ville));
            }
        }
        
        async function sauvegarderDonnees() {
            const donnees = {
                voyage: {
                    nom: document.getElementById('nomVoyage').value,
                    destination: document.getElementById('destination').value,
                    duree: parseInt(document.getElementById('duree').value),
                    type: document.getElementById('typeVoyage').value
                },
                categories: listeActuelle,
                timestamp: new Date().toISOString()
            };
            
            const succes = await storageManager.saveData(CONFIG.STORAGE_KEYS.MAIN, donnees);
            if (succes) {
                showToast('üíæ Donn√©es sauvegard√©es!', 'success');
                await chargerMeteo();
                await genererSuggestionsIA();
            } else {
                showToast('‚ùå Erreur sauvegarde', 'error');
            }
        }
        
        async function chargerMeteo() {
            const destination = document.getElementById('destination').value;
            if (!destination) {
                document.getElementById('weatherInfo').innerHTML = 'üåç Entrez une destination pour voir la m√©t√©o';
                return;
            }
            
            document.getElementById('weatherInfo').innerHTML = '‚è≥ Chargement...';
            const meteo = await weatherService.getWeather(destination);
            
            document.getElementById('weatherInfo').innerHTML = `
                <div style="display: grid; grid-template-columns: auto 1fr; gap: 10px; align-items: center;">
                    <div style="font-size: 2em;">${meteo.icon}</div>
                    <div>
                        <div style="font-size: 1.5em; font-weight: bold;">${meteo.temperature}¬∞C</div>
                        <div>${meteo.condition}</div>
                        <div>üíß Pluie: ${meteo.rainProbability}% ‚Ä¢ üí® Vent: ${meteo.wind} km/h</div>
                    </div>
                </div>
            `;
        }
        
        async function genererSuggestionsIA() {
            const voyageData = {
                type: document.getElementById('typeVoyage').value,
                duree: parseInt(document.getElementById('duree').value),
                destination: document.getElementById('destination').value
            };
            
            const destination = document.getElementById('destination').value;
            const meteo = destination ? await weatherService.getWeather(destination) : null;
            
            const suggestions = await aiEngine.generateSuggestions(voyageData, meteo);
            
            const suggestionsHTML = suggestions.map(suggestion => 
                `<div style="padding: 5px 0; border-bottom: 1px solid #e0e0e0;">‚Ä¢ ${suggestion}</div>`
            ).join('');
            
            document.getElementById('suggestionsList').innerHTML = suggestionsHTML || 'Aucune suggestion pour le moment';
        }
        
        function genererCategories() {
            const container = document.getElementById('categoriesContainer');
            container.innerHTML = '';
            
            if (Object.keys(listeActuelle).length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">Aucune cat√©gorie. Cr√©ez-en une pour commencer!</div>';
                return;
            }
            
            for (const [categorie, articles] of Object.entries(listeActuelle)) {
                const divCategorie = document.createElement('div');
                divCategorie.className = 'categorie-card';
                divCategorie.innerHTML = `
                    <div class="categorie-header">
                        <h3>${categorie}</h3>
                    </div>
                    <div class="items-container">
                        ${articles.length > 0 ? articles.map(article => `
                            <div class="item">
                                <input type="checkbox" onchange="cocherItem('${categorie}', '${article.nom || article}')" ${article.coche ? 'checked' : ''}>
                                <span>${article.nom || article}</span>
                                <input type="number" value="${article.quantite || 1}" min="1" style="width: 50px; margin-left: auto;" onchange="changerQuantite('${categorie}', '${article.nom || article}', this.value)">
                                <select onchange="changerBagage('${categorie}', '${article.nom || article}', this.value)" style="margin-left: 10px;">
                                    <option value="main" ${article.bagage === 'main' ? 'selected' : ''}>üíº Main</option>
                                    <option value="soute" ${article.bagage === 'soute' ? 'selected' : ''}>üß≥ Soute</option>
                                </select>
                                <button onclick="supprimerItem('${categorie}', '${article.nom || article}')" style="background: var(--danger-color); padding: 5px 8px; margin-left: 5px;">üóëÔ∏è</button>
                            </div>
                        `).join('') : '<div style="text-align: center; color: #666; padding: 20px;">Aucun article</div>'}
                        <div style="display: flex; gap: 10px; margin-top: 15px;">
                            <input type="text" id="nouvel-item-${categorie}" placeholder="Nouvel article..." style="flex: 1;">
                            <button onclick="ajouterItem('${categorie}')">‚ûï Ajouter</button>
                        </div>
                    </div>
                `;
                container.appendChild(divCategorie);
            }
        }
        
        function ajouterCategorie() {
            const nomCategorie = document.getElementById('nomNouvelleCategorie').value.trim();
            if (nomCategorie && !listeActuelle[nomCategorie]) {
                listeActuelle[nomCategorie] = [];
                document.getElementById('nomNouvelleCategorie').value = '';
                genererCategories();
                sauvegarderDonnees();
                showToast(`üìÅ Cat√©gorie "${nomCategorie}" cr√©√©e!`, 'success');
            }
        }
        
        function ajouterItem(categorie) {
            const input = document.getElementById(`nouvel-item-${categorie}`);
            const nomItem = input.value.trim();
            if (nomItem) {
                if (!listeActuelle[categorie]) listeActuelle[categorie] = [];
                
                listeActuelle[categorie].push({
                    nom: nomItem,
                    quantite: 1,
                    bagage: 'main',
                    coche: false
                });
                
                input.value = '';
                genererCategories();
                sauvegarderDonnees();
            }
        }
        
        function supprimerItem(categorie, nomItem) {
            if (confirm(`Supprimer "${nomItem}" ?`)) {
                listeActuelle[categorie] = listeActuelle[categorie].filter(item => 
                    (item.nom || item) !== nomItem
                );
                genererCategories();
                sauvegarderDonnees();
            }
        }
        
        function cocherItem(categorie, nomItem) {
            const item = listeActuelle[categorie].find(item => (item.nom || item) === nomItem);
            if (item) {
                if (typeof item === 'object') {
                    item.coche = !item.coche;
                }
            }
            mettreAJourProgression();
            sauvegarderDonnees();
        }
        
        function changerQuantite(categorie, nomItem, quantite) {
            const item = listeActuelle[categorie].find(item => (item.nom || item) === nomItem);
            if (item && typeof item === 'object') {
                item.quantite = parseInt(quantite) || 1;
                sauvegarderDonnees();
            }
        }
        
        function changerBagage(categorie, nomItem, bagage) {
            const item = listeActuelle[categorie].find(item => (item.nom || item) === nomItem);
            if (item) {
                if (typeof item === 'object') {
                    item.bagage = bagage;
                }
                sauvegarderDonnees();
            }
        }
        
        function mettreAJourProgression() {
            let totalItems = 0;
            let itemsCoches = 0;
            
            for (const categorie in listeActuelle) {
                for (const item of listeActuelle[categorie]) {
                    totalItems++;
                    if (typeof item === 'object' && item.coche) {
                        itemsCoches++;
                    }
                }
            }
            
            const pourcentage = totalItems > 0 ? Math.round((itemsCoches / totalItems) * 100) : 0;
            
            document.getElementById('progression').textContent = 
                `${itemsCoches}/${totalItems} articles pr√©par√©s (${pourcentage}%)`;
            
            document.getElementById('progressionBar').style.width = `${pourcentage}%`;
        }
        
        function exporterPDF() {
            exportManager.exporterPDF();
        }
        
        function exporterExcel() {
            exportManager.exporterExcel();
        }
        
        function partagerListeAvance() {
            const nomVoyage = document.getElementById('nomVoyage').value || 'Mon voyage';
            const totalArticles = Object.values(listeActuelle).flat().length;
            const articlesCoches = Object.values(listeActuelle)
                .flat()
                .filter(item => typeof item === 'object' && item.coche)
                .length;
            
            const pourcentage = totalArticles > 0 ? Math.round((articlesCoches / totalArticles) * 100) : 0;
            
            if (navigator.share) {
                navigator.share({
                    title: `PackMaster - ${nomVoyage}`,
                    text: `Notre liste de voyage "${nomVoyage}" est pr√©par√©e √† ${pourcentage}% ! Rejoins-moi sur PackMaster pour collaborer.`,
                    url: window.location.href
                });
            } else {
                alert(`Partagez ce lien avec votre √©quipe:\n\n${window.location.href}\n\nProgression: ${pourcentage}%`);
            }
        }
        
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // =============================================================================
        // D√âMARRAGE DE L'APPLICATION
        // =============================================================================
        
        document.addEventListener('DOMContentLoaded', function() {
            initialiserApplication();
            
            // Sauvegarde automatique lors des modifications
            document.getElementById('nomVoyage').addEventListener('input', sauvegarderDonnees);
            document.getElementById('destination').addEventListener('input', sauvegarderDonnees);
            document.getElementById('duree').addEventListener('change', sauvegarderDonnees);
            document.getElementById('typeVoyage').addEventListener('change', sauvegarderDonnees);
        });
    </script>
</body>
</html>